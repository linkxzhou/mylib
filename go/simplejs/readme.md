# SimpleJS

## æ¶æ„åˆ†æ

### 1. æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SimpleJS æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å…¬å…±æ¥å£å±‚ (simplejs.h)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   åˆ›å»º/é”€æ¯     â”‚   å€¼æ“ä½œæ¥å£     â”‚   æ‰§è¡Œæ¥å£       â”‚    â”‚
â”‚  â”‚ js_create()     â”‚ js_mkstr()      â”‚ js_eval()       â”‚    â”‚
â”‚  â”‚ js_stats()      â”‚ js_mknum()      â”‚ js_str()        â”‚    â”‚
â”‚  â”‚ js_setgct()     â”‚ js_mkobj()      â”‚ js_truthy()     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ¸å¿ƒå¼•æ“å±‚ (simplejs.cc)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   è¯æ³•åˆ†æå™¨     â”‚   è¯­æ³•è§£æå™¨     â”‚   æ‰§è¡Œå¼•æ“       â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚ â”‚Tokenè¯†åˆ«    â”‚ â”‚ â”‚è¡¨è¾¾å¼è§£æ   â”‚ â”‚ â”‚è¿ç®—ç¬¦æ‰§è¡Œ   â”‚ â”‚    â”‚
â”‚  â”‚ â”‚å…³é”®å­—è§£æ   â”‚ â”‚ â”‚è¯­å¥è§£æ     â”‚ â”‚ â”‚å‡½æ•°è°ƒç”¨     â”‚ â”‚    â”‚
â”‚  â”‚ â”‚å­—ç¬¦ä¸²/æ•°å­—  â”‚ â”‚ â”‚ä½œç”¨åŸŸç®¡ç†   â”‚ â”‚ â”‚æ§åˆ¶æµ       â”‚ â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å†…å­˜ç®¡ç†å±‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   å€¼ç±»å‹ç³»ç»Ÿ     â”‚   å†…å­˜åˆ†é…å™¨     â”‚   åƒåœ¾å›æ”¶å™¨     â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚ â”‚NaN Boxing   â”‚ â”‚ â”‚çº¿æ€§åˆ†é…     â”‚ â”‚ â”‚æ ‡è®°æ¸…é™¤     â”‚ â”‚    â”‚
â”‚  â”‚ â”‚ç±»å‹ç¼–ç      â”‚ â”‚ â”‚4å­—èŠ‚å¯¹é½    â”‚ â”‚ â”‚å¼•ç”¨è¿½è¸ª     â”‚ â”‚    â”‚
â”‚  â”‚ â”‚æ•°æ®æ‰“åŒ…     â”‚ â”‚ â”‚å®ä½“ç®¡ç†     â”‚ â”‚ â”‚å†…å­˜å‹ç¼©     â”‚ â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒæ•°æ®ç»“æ„åˆ†æ

#### 2.1 JSå¼•æ“ç»“æ„ä½“ (struct js)
```c
struct js {
  // å†…å­˜ç®¡ç†
  uint8_t *mem;       // JSå†…å­˜æ± 
  jsoff_t size;       // å†…å­˜æ± å¤§å°
  jsoff_t brk;        // å½“å‰ä½¿ç”¨è¾¹ç•Œ
  jsoff_t gct;        // GCè§¦å‘é˜ˆå€¼
  jsoff_t nogc;       // GCæ’é™¤å®ä½“åç§»
  
  // è§£æçŠ¶æ€
  const char *code;   // å½“å‰è§£æä»£ç 
  jsoff_t clen;       // ä»£ç é•¿åº¦
  jsoff_t pos;        // è§£æä½ç½®
  uint8_t tok;        // å½“å‰token
  uint8_t consumed;   // tokenæ¶ˆè´¹æ ‡å¿—
  
  // æ‰§è¡ŒçŠ¶æ€
  jsval_t scope;      // å½“å‰ä½œç”¨åŸŸ
  uint8_t flags;      // æ‰§è¡Œæ ‡å¿—
  jsval_t tval;       // ä¸´æ—¶å€¼
  
  // è°ƒè¯•ä¿¡æ¯
  jsoff_t css;        // Cæ ˆæœ€å¤§ä½¿ç”¨
  jsoff_t lwm;        // JSå†…å­˜æœ€ä½æ°´ä½
  char errmsg[33];    // é”™è¯¯æ¶ˆæ¯
};
```

#### 2.2 JSå€¼ç±»å‹ç³»ç»Ÿ (jsval_t)
ä½¿ç”¨NaN BoxingæŠ€æœ¯å°†æ‰€æœ‰JSå€¼æ‰“åŒ…åˆ°64ä½æ•´æ•°ä¸­ï¼š
```
æ•°å­—ç±»å‹: ç›´æ¥å­˜å‚¨IEEE 754åŒç²¾åº¦æµ®ç‚¹æ•°
å…¶ä»–ç±»å‹: ä½¿ç”¨NaNæ ‡è®° + 4ä½ç±»å‹ + 48ä½æ•°æ®

æ ¼å¼: [NaNæ ‡è®°:12ä½][ç±»å‹:4ä½][æ•°æ®:48ä½]
      11111111 1111tttt vvvvvvvv...vvvvvvvv

ç±»å‹ç¼–ç :
- T_UNDEF (3): undefined
- T_NULL (4): null  
- T_BOOL (6): boolean
- T_STR (2): å­—ç¬¦ä¸²(å†…å­˜åç§»)
- T_OBJ (0): å¯¹è±¡(å†…å­˜åç§»)
- T_FUNC (7): å‡½æ•°(å†…å­˜åç§»)
- T_CFUNC (9): Cå‡½æ•°(å‡½æ•°æŒ‡é’ˆ)
- T_ERR (10): é”™è¯¯
```

### 3. ä¸»è¦åŠŸèƒ½æ¨¡å—æ‹†è§£

#### 3.1 è¯æ³•åˆ†æå™¨ (Lexer)
**æ ¸å¿ƒå‡½æ•°**: `next()`, `parsekeyword()`, `skiptonext()`

**åŠŸèƒ½**:
- è·³è¿‡ç©ºç™½å­—ç¬¦å’Œæ³¨é‡Š
- è¯†åˆ«å…³é”®å­— (function, if, for, let, constç­‰)
- è§£æå­—ç¬¦ä¸²å­—é¢é‡ (æ”¯æŒè½¬ä¹‰å­—ç¬¦)
- è§£ææ•°å­—å­—é¢é‡ (æ•´æ•°ã€æµ®ç‚¹æ•°ã€ç§‘å­¦è®¡æ•°æ³•)
- è¯†åˆ«æ“ä½œç¬¦å’Œåˆ†éš”ç¬¦
- å¤„ç†æ ‡è¯†ç¬¦

**Tokenç±»å‹**:
```c
enum {
  // åŸºç¡€token
  TOK_ERR, TOK_EOF, TOK_IDENTIFIER, TOK_NUMBER, TOK_STRING,
  TOK_SEMICOLON, TOK_LPAREN, TOK_RPAREN, TOK_LBRACE, TOK_RBRACE,
  
  // å…³é”®å­— (50-99)
  TOK_BREAK, TOK_CASE, TOK_CONST, TOK_FUNC, TOK_IF, TOK_FOR,
  TOK_LET, TOK_RETURN, TOK_VAR, TOK_WHILE, ...
  
  // æ“ä½œç¬¦ (100+)
  TOK_DOT, TOK_CALL, TOK_PLUS, TOK_MINUS, TOK_MUL, TOK_DIV,
  TOK_ASSIGN, TOK_EQ, TOK_NE, TOK_LT, TOK_GT, ...
};
```

#### 3.2 è¯­æ³•è§£æå™¨ (Parser)
**æ ¸å¿ƒå‡½æ•°**: `js_expr()`, `js_stmt()`, `js_block()`

**è¡¨è¾¾å¼è§£æ** (`js_expr`):
- è¿ç®—ç¬¦ä¼˜å…ˆçº§å¤„ç†
- ä¸€å…ƒè¿ç®—ç¬¦ (+, -, !, ~, typeof)
- äºŒå…ƒè¿ç®—ç¬¦ (ç®—æœ¯ã€æ¯”è¾ƒã€é€»è¾‘ã€ä½è¿ç®—)
- ä¸‰å…ƒè¿ç®—ç¬¦ (? :)
- å‡½æ•°è°ƒç”¨
- å±æ€§è®¿é—®
- æ•°ç»„/å¯¹è±¡å­—é¢é‡

**è¯­å¥è§£æ** (`js_stmt`):
- å˜é‡å£°æ˜ (let, const, var)
- å‡½æ•°å£°æ˜
- æ§åˆ¶æµ (if/else, for, while, break, return)
- è¡¨è¾¾å¼è¯­å¥
- å—è¯­å¥

#### 3.3 æ‰§è¡Œå¼•æ“
**æ ¸å¿ƒå‡½æ•°**: `do_op()`, `js_call()`, `resolveprop()`

**è¿ç®—ç¬¦æ‰§è¡Œ**:
- ç®—æœ¯è¿ç®— (+, -, *, /, %)
- æ¯”è¾ƒè¿ç®— (==, !=, <, >, <=, >=)
- é€»è¾‘è¿ç®— (&&, ||, !)
- ä½è¿ç®— (&, |, ^, <<, >>, >>>)
- èµ‹å€¼è¿ç®—

**å‡½æ•°è°ƒç”¨æœºåˆ¶**:
- å‚æ•°ä¼ é€’
- ä½œç”¨åŸŸåˆ›å»º
- è¿”å›å€¼å¤„ç†
- é€’å½’è°ƒç”¨æ”¯æŒ

### 4. å†…å­˜ç®¡ç†æœºåˆ¶

#### 4.1 çº¿æ€§å†…å­˜åˆ†é…å™¨
```
å†…å­˜å¸ƒå±€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®ä½“1   â”‚ å®ä½“2   â”‚ å®ä½“3   â”‚ å®ä½“N   â”‚   æœªä½¿ç”¨ç©ºé—´     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
0        brk                                            size
```

**å®ä½“ç±»å‹**:
- **å¯¹è±¡** (8å­—èŠ‚): [é¦–å±æ€§åç§»:4å­—èŠ‚][çˆ¶å¯¹è±¡åç§»:4å­—èŠ‚]
- **å±æ€§** (12+å­—èŠ‚): [ä¸‹ä¸€å±æ€§åç§»:4å­—èŠ‚][é”®åç§»:4å­—èŠ‚][å€¼:8å­—èŠ‚]
- **å­—ç¬¦ä¸²** (4+Nå­—èŠ‚): [é•¿åº¦<<2|ç±»å‹:4å­—èŠ‚][æ•°æ®:Nå­—èŠ‚å¯¹é½]

**åˆ†é…ç­–ç•¥**:
- 4å­—èŠ‚å¯¹é½åˆ†é…
- çº¿æ€§å¢é•¿ï¼ŒbrkæŒ‡å‘ä¸‹ä¸€ä¸ªå¯ç”¨ä½ç½®
- å®ä½“ç±»å‹ç¼–ç åœ¨åç§»é‡çš„ä½2ä½

#### 4.2 åƒåœ¾å›æ”¶æœºåˆ¶
**ç®—æ³•**: æ ‡è®°-æ¸…é™¤ (Mark and Sweep)

**GCè§¦å‘æ¡ä»¶**:
- å†…å­˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼ (brk > gct)
- æ‰‹åŠ¨è°ƒç”¨ js_gc()

**GCæµç¨‹**:
1. **æ ‡è®°é˜¶æ®µ**: æ ‡è®°æ‰€æœ‰å®ä½“ä¸ºå¾…åˆ é™¤
2. **è¿½è¸ªé˜¶æ®µ**: ä»æ ¹å¯¹è±¡(scope)å¼€å§‹è¿½è¸ªå¯è¾¾å®ä½“
3. **æ¸…é™¤é˜¶æ®µ**: åˆ é™¤æœªæ ‡è®°å®ä½“ï¼Œå‹ç¼©å†…å­˜
4. **ä¿®å¤é˜¶æ®µ**: æ›´æ–°æ‰€æœ‰åç§»é‡å¼•ç”¨

### 5. è¯æ³•åˆ†æå’Œè¯­æ³•è§£ææµç¨‹

#### 5.1 è¯æ³•åˆ†ææµç¨‹
```
è¾“å…¥ä»£ç  â†’ skiptonext() â†’ è¯†åˆ«tokenç±»å‹ â†’ è§£ætokenå€¼ â†’ è¿”å›token
    â†“           â†“              â†“            â†“           â†“
  "let x"   è·³è¿‡ç©ºç™½      TOK_LET      è®¾ç½®toff/tlen   TOK_LET
    â†“           â†“              â†“            â†“           â†“  
   " x"     è·³è¿‡ç©ºç™½    TOK_IDENTIFIER  è®¾ç½®tval     TOK_IDENTIFIER
```

#### 5.2 è¯­æ³•è§£ææµç¨‹
```
é€’å½’ä¸‹é™è§£æ:
js_eval() â†’ js_stmt() â†’ js_expr() â†’ js_unary() â†’ js_postfix() â†’ js_primary()
    â†‘           â†‘          â†‘           â†‘            â†‘             â†‘
  æ‰§è¡Œå…¥å£    è¯­å¥è§£æ   è¡¨è¾¾å¼è§£æ   ä¸€å…ƒè¿ç®—     åç¼€è¿ç®—      åŸºç¡€è¡¨è¾¾å¼
```

**ä¼˜å…ˆçº§å¤„ç†**:
- ä½¿ç”¨é€’å½’ä¸‹é™ + è¿ç®—ç¬¦ä¼˜å…ˆçº§è¡¨
- å·¦ç»“åˆæ€§é€šè¿‡å¾ªç¯å®ç°
- å³ç»“åˆæ€§é€šè¿‡é€’å½’å®ç°

### 6. å€¼ç±»å‹ç³»ç»Ÿè¯¦è§£

#### 6.1 ç±»å‹æ£€æŸ¥å’Œè½¬æ¢
```c
// ç±»å‹æ£€æŸ¥
uint8_t vtype(jsval_t v)     // è·å–å€¼ç±»å‹
bool is_nan(jsval_t v)       // æ£€æŸ¥æ˜¯å¦ä¸ºNaNç¼–ç 
bool js_truthy(jsval_t v)    // çœŸå€¼æ£€æŸ¥

// ç±»å‹è½¬æ¢
double tod(jsval_t v)        // è½¬æ¢ä¸ºdouble
jsval_t tov(double d)        // ä»doubleè½¬æ¢
size_t vdata(jsval_t v)      // æå–æ•°æ®éƒ¨åˆ†
```

#### 6.2 å€¼åˆ›å»ºæ¥å£
```c
jsval_t js_mkundef()         // åˆ›å»ºundefined
jsval_t js_mknull()          // åˆ›å»ºnull
jsval_t js_mktrue()          // åˆ›å»ºtrue
jsval_t js_mkfalse()         // åˆ›å»ºfalse
jsval_t js_mknum(double)     // åˆ›å»ºæ•°å­—
jsval_t js_mkstr()           // åˆ›å»ºå­—ç¬¦ä¸²
jsval_t js_mkobj()           // åˆ›å»ºå¯¹è±¡
```

### 7. åƒåœ¾å›æ”¶æœºåˆ¶è¯¦è§£

#### 7.1 æ ‡è®°ç®—æ³•
```c
// æ ‡è®°æ‰€æœ‰å®ä½“ä¸ºå¾…åˆ é™¤
void js_mark_all_entities_for_deletion(struct js *js)

// ä»æ ¹å¼€å§‹å–æ¶ˆæ ‡è®°å¯è¾¾å®ä½“  
void js_unmark_used_entities(struct js *js)

// åˆ é™¤æ ‡è®°çš„å®ä½“å¹¶å‹ç¼©å†…å­˜
void js_delete_marked_entities(struct js *js)
```

#### 7.2 å¼•ç”¨è¿½è¸ª
- ä»å½“å‰ä½œç”¨åŸŸå¼€å§‹
- é€’å½’è¿½è¸ªå¯¹è±¡å±æ€§
- è¿½è¸ªå­—ç¬¦ä¸²å¼•ç”¨
- è¿½è¸ªå‡½æ•°é—­åŒ…

#### 7.3 å†…å­˜å‹ç¼©
- ç§»é™¤æ ‡è®°å®ä½“
- å‘å‰ç§»åŠ¨æœªæ ‡è®°å®ä½“
- æ›´æ–°æ‰€æœ‰åç§»é‡å¼•ç”¨
- è°ƒæ•´brkè¾¹ç•Œ

### 8. æ”¯æŒçš„JavaScriptç‰¹æ€§

#### 8.1 æ•°æ®ç±»å‹
- âœ… undefined, null
- âœ… boolean (true/false)
- âœ… number (IEEE 754åŒç²¾åº¦)
- âœ… string (UTF-8)
- âœ… object (é”®å€¼å¯¹)
- âœ… function (ç”¨æˆ·å®šä¹‰å’ŒCå‡½æ•°)

#### 8.2 è¿ç®—ç¬¦
- âœ… ç®—æœ¯: +, -, *, /, %
- âœ… æ¯”è¾ƒ: ==, !=, <, >, <=, >=
- âœ… é€»è¾‘: &&, ||, !
- âœ… ä½è¿ç®—: &, |, ^, <<, >>, >>>
- âœ… èµ‹å€¼: =, +=, -=, *=, /=ç­‰
- âœ… ä¸‰å…ƒ: ? :

#### 8.3 æ§åˆ¶æµ
- âœ… if/elseæ¡ä»¶è¯­å¥
- âœ… forå¾ªç¯ (Cé£æ ¼)
- âœ… whileå¾ªç¯
- âœ… break/continue
- âœ… returnè¯­å¥

#### 8.4 å‡½æ•°
- âœ… å‡½æ•°å£°æ˜å’Œè°ƒç”¨
- âœ… å‚æ•°ä¼ é€’
- âœ… è¿”å›å€¼
- âœ… é€’å½’è°ƒç”¨
- âœ… Cå‡½æ•°ç»‘å®š

#### 8.5 å¯¹è±¡
- âœ… å¯¹è±¡å­—é¢é‡ {key: value}
- âœ… å±æ€§è®¿é—® obj.prop
- âœ… å±æ€§èµ‹å€¼
- âœ… åŠ¨æ€å±æ€§

### 9. æ€§èƒ½ç‰¹ç‚¹

#### 9.1 å†…å­˜æ•ˆç‡
- NaN Boxingå‡å°‘å†…å­˜å ç”¨
- çº¿æ€§åˆ†é…å™¨é¿å…ç¢ç‰‡
- ç´§å‡‘çš„å®ä½“å­˜å‚¨æ ¼å¼
- é«˜æ•ˆçš„åƒåœ¾å›æ”¶

#### 9.2 æ‰§è¡Œæ•ˆç‡  
- å•éè§£ææ‰§è¡Œ
- æœ€å°åŒ–å†…å­˜åˆ†é…
- ä¼˜åŒ–çš„è¿ç®—ç¬¦å®ç°
- è½»é‡çº§å‡½æ•°è°ƒç”¨

#### 9.3 ä»£ç å¤§å°
- å•æ–‡ä»¶å®ç° (~1400è¡Œ)
- æœ€å°åŒ–ä¾èµ–
- å¯é…ç½®ç‰¹æ€§
- é€‚åˆåµŒå…¥å¼ç¯å¢ƒ

---

## C++11é‡å†™å®Œæˆ

âœ… **SimpleJS v2.0 å·²å®Œæˆï¼** åŸºäºC++11çš„ç°ä»£åŒ–é‡å†™ï¼ŒåŒ…å«ä»¥ä¸‹ç‰¹æ€§ï¼š

### ğŸš€ å·²å®ç°çš„C++11ç‰¹æ€§

1. **æ™ºèƒ½æŒ‡é’ˆ**: ä½¿ç”¨`std::unique_ptr`ç®¡ç†å†…å­˜ï¼ˆå…¼å®¹C++11ï¼‰
2. **ç±»å°è£…**: å°†Cç»“æ„ä½“é‡æ„ä¸ºç°ä»£C++ç±»
3. **RAII**: è‡ªåŠ¨èµ„æºç®¡ç†å’Œå¼‚å¸¸å®‰å…¨
4. **å¼ºç±»å‹æšä¸¾**: ä½¿ç”¨`enum class`æ›¿æ¢Cæšä¸¾
5. **constexpr**: ç¼–è¯‘æ—¶å¸¸é‡å’Œä¼˜åŒ–
6. **lambdaè¡¨è¾¾å¼**: ç”¨äºå†…ç½®å‡½æ•°å’Œå›è°ƒ
7. **å¼‚å¸¸å¤„ç†**: ç±»å‹å®‰å…¨çš„é”™è¯¯å¤„ç†æœºåˆ¶
8. **æ¨¡æ¿**: ç±»å‹å®‰å…¨çš„æ³›å‹ç¼–ç¨‹
9. **å‘½åç©ºé—´**: é¿å…å…¨å±€å‘½åå†²çª
10. **ç°ä»£æ„é€ å‡½æ•°**: å§”æ‰˜æ„é€ å’Œåˆå§‹åŒ–åˆ—è¡¨

### ğŸ“ æ–‡ä»¶ç»“æ„

- `simplejs_v2.h` - å•ä¸ªå¤´æ–‡ä»¶å®ç°ï¼ŒåŒ…å«å®Œæ•´çš„JavaScriptè§£é‡Šå™¨
- `test_v2.cpp` - æµ‹è¯•ç¨‹åºï¼ŒéªŒè¯æ‰€æœ‰åŠŸèƒ½
- `Makefile_v2` - æ„å»ºç³»ç»Ÿï¼Œæ”¯æŒå¤šç§æµ‹è¯•å’Œåˆ†æ

### ğŸ”§ ä½¿ç”¨æ–¹æ³•

#### åŸºæœ¬ä½¿ç”¨
```cpp
#include "simplejs_v2.h"
using namespace simplejs;

int main() {
    // åˆ›å»ºJSå¼•æ“ï¼ˆ64KBå†…å­˜ï¼‰
    JSEngine engine(64 * 1024);
    
    // æ‰§è¡ŒJavaScriptä»£ç 
    JSValue result = engine.evaluate("let x = 42; x + 8");
    
    // è·å–ç»“æœ
    std::cout << "Result: " << engine.valueToString(result) << std::endl;
    
    return 0;
}
```

#### é«˜çº§åŠŸèƒ½
```cpp
// åˆ›å»ºå’Œæ“ä½œJSå€¼
JSValue num = engine.createNumber(3.14);
JSValue str = engine.createString("Hello");
JSValue obj = engine.createObject();
JSValue arr = engine.createArray();

// ç±»å‹æ£€æŸ¥
if (num.isNumber()) {
    double value = num.asNumber();
}

// æ³¨å†ŒC++å‡½æ•°
engine.registerNativeFunction("myFunc", [](JSEngine& engine, const std::vector<JSValue>& args) {
    return engine.createString("Called from C++!");
});

// å†…å­˜ç®¡ç†
engine.runGarbageCollection();
std::cout << "Used memory: " << engine.getUsedMemory() << " bytes" << std::endl;
```

#### Cå…¼å®¹API
```c
// å…¼å®¹åŸå§‹C API
struct js* engine = js_create(NULL, 64 * 1024);
uint64_t result = js_eval(engine, "42 + 8", 6);
const char* str = js_str(engine, result);
bool truthy = js_truthy(engine, result);
js_destroy(engine);
```

### ğŸ› ï¸ æ„å»ºå’Œæµ‹è¯•

```bash
# è¯­æ³•æ£€æŸ¥
make -f Makefile_v2 check

# ç¼–è¯‘å’Œè¿è¡Œæµ‹è¯•
make -f Makefile_v2 test

# è°ƒè¯•ç‰ˆæœ¬
make -f Makefile_v2 debug test-debug

# æ€§èƒ½æµ‹è¯•
make -f Makefile_v2 perf

# å†…å­˜æ£€æŸ¥ï¼ˆéœ€è¦valgrindï¼‰
make -f Makefile_v2 memtest

# é™æ€åˆ†æï¼ˆéœ€è¦cppcheckï¼‰
make -f Makefile_v2 analyze

# æ¸…ç†
make -f Makefile_v2 clean

# æŸ¥çœ‹æ‰€æœ‰é€‰é¡¹
make -f Makefile_v2 help
```

### âœ¨ ä¸»è¦æ”¹è¿›

#### ç›¸æ¯”åŸç‰ˆçš„ä¼˜åŠ¿
1. **ç±»å‹å®‰å…¨**: å¼ºç±»å‹æšä¸¾å’Œæ¨¡æ¿é¿å…ç±»å‹é”™è¯¯
2. **å†…å­˜å®‰å…¨**: RAIIå’Œæ™ºèƒ½æŒ‡é’ˆé˜²æ­¢å†…å­˜æ³„æ¼
3. **å¼‚å¸¸å®‰å…¨**: ç°ä»£å¼‚å¸¸å¤„ç†æœºåˆ¶
4. **ä»£ç å¯è¯»æ€§**: æ¸…æ™°çš„ç±»ç»“æ„å’Œå‘½åç©ºé—´
5. **æ‰©å±•æ€§**: æ›´å®¹æ˜“æ·»åŠ æ–°åŠŸèƒ½å’Œä¼˜åŒ–
6. **è°ƒè¯•å‹å¥½**: æ›´å¥½çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ”¯æŒ

#### æ€§èƒ½ç‰¹ç‚¹
- **é›¶å¼€é”€æŠ½è±¡**: C++11ç‰¹æ€§ä¸å½±å“è¿è¡Œæ—¶æ€§èƒ½
- **ç¼–è¯‘æ—¶ä¼˜åŒ–**: constexprå’Œæ¨¡æ¿ä¼˜åŒ–
- **å†…å­˜æ•ˆç‡**: ä¿æŒåŸæœ‰çš„NaN Boxingå’Œçº¿æ€§åˆ†é…
- **å…¼å®¹æ€§**: å®Œå…¨å…¼å®¹åŸå§‹C API

### ğŸ§ª æµ‹è¯•ç»“æœ

```
SimpleJS v2.0 Test Program
Version: 2.0.0
==========================

âœ… åŸºæœ¬å€¼åˆ›å»ºå’Œç±»å‹æ£€æŸ¥
âœ… çœŸå€¼åˆ¤æ–­
âœ… å¯¹è±¡å’Œæ•°ç»„åˆ›å»º
âœ… å†…å­˜ç®¡ç†ç»Ÿè®¡
âœ… è¯æ³•åˆ†æå™¨
âœ… åŸºæœ¬è¡¨è¾¾å¼æ±‚å€¼
âœ… C APIå…¼å®¹æ€§

å†…å­˜ä½¿ç”¨: 44/65536 å­—èŠ‚ (0.07%)
æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

### ğŸ“Š æ¶æ„å¯¹æ¯”

| ç‰¹æ€§ | SimpleJS v1 (C) | SimpleJS v2 (C++11) |
|------|----------------|---------------------|
| ä»£ç è¡Œæ•° | ~1400è¡Œ | ~1450è¡Œ |
| æ–‡ä»¶æ•°é‡ | 2ä¸ªæ–‡ä»¶ | 1ä¸ªå¤´æ–‡ä»¶ |
| å†…å­˜ç®¡ç† | æ‰‹åŠ¨ç®¡ç† | RAII + æ™ºèƒ½æŒ‡é’ˆ |
| é”™è¯¯å¤„ç† | è¿”å›ç  | å¼‚å¸¸æœºåˆ¶ |
| ç±»å‹å®‰å…¨ | å¼±ç±»å‹ | å¼ºç±»å‹ |
| APIé£æ ¼ | Cé£æ ¼ | C++ + Cå…¼å®¹ |
| æ‰©å±•æ€§ | ä¸­ç­‰ | é«˜ |
| è°ƒè¯•æ€§ | åŸºæœ¬ | å¢å¼º |

### ğŸ¯ æœªæ¥è®¡åˆ’

è™½ç„¶æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œä½†è¿˜æœ‰ä¸€äº›å¢å¼ºåŠŸèƒ½å¯ä»¥æ·»åŠ ï¼š

1. **å®Œæ•´çš„è¯­æ³•è§£æå™¨**: å½“å‰æ˜¯åŸºç¡€å®ç°ï¼Œå¯æ‰©å±•æ”¯æŒæ›´å¤šJSç‰¹æ€§
2. **ä¼˜åŒ–çš„åƒåœ¾å›æ”¶**: å®ç°å¢é‡GCå’Œåˆ†ä»£GC
3. **JITç¼–è¯‘**: æ·»åŠ å³æ—¶ç¼–è¯‘æ”¯æŒ
4. **æ¨¡å—ç³»ç»Ÿ**: æ”¯æŒES6æ¨¡å—
5. **å¼‚æ­¥æ”¯æŒ**: Promiseå’Œasync/await
6. **è°ƒè¯•å™¨æ¥å£**: æ”¯æŒæ–­ç‚¹å’Œå•æ­¥è°ƒè¯•

---

## æ€»ç»“

SimpleJS v2.0 æˆåŠŸå°†åŸå§‹çš„Cå®ç°ç°ä»£åŒ–ä¸ºC++11ç‰ˆæœ¬ï¼Œåœ¨ä¿æŒæ€§èƒ½å’Œå…¼å®¹æ€§çš„åŒæ—¶ï¼Œå¤§å¤§æå‡äº†ä»£ç çš„å®‰å…¨æ€§ã€å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚è¿™ä¸ªå•å¤´æ–‡ä»¶å®ç°å¯ä»¥è½»æ¾é›†æˆåˆ°ä»»ä½•C++é¡¹ç›®ä¸­ï¼Œä¸ºåµŒå…¥å¼JavaScriptåŠŸèƒ½æä¾›äº†ä¸€ä¸ªä¼˜ç§€çš„è§£å†³æ–¹æ¡ˆã€‚

A lightweight JavaScript interpreter implemented in C with minimal dependencies. SimpleJS provides a compact and efficient way to embed JavaScript functionality in your C/C++ applications.

## Features

- Ultra-compact JavaScript engine (< 2000 lines of code)
- Extremely low memory footprint
- Zero external dependencies
- C API for seamless integration
- Core JavaScript functionality:
  - Variables and lexical scoping
  - Objects with properties
  - Functions and closures
  - Control flow (if, for)
  - Operators and expressions
  - String manipulation

## Usage

### Basic Example

```c
#include "simplejs.h"
#include <stdio.h>
#include <stdlib.h>

int main() {
    // Allocate memory for SimpleJS
    const size_t size = 64 * 1024;  // 64 KB
    void* mem = malloc(size);
    
    // Create JS instance
    struct js* js = js_create(mem, size);
    
    // Evaluate JavaScript code
    jsval_t result = js_eval(js, "let x = 10; let y = 20; x + y", ~0U);
    
    // Print the result
    printf("Result: %s\n", js_str(js, result));
    
    // Free memory
    free(js);
    return 0;
}
```

### Memory Management

SimpleJS provides garbage collection and memory control:

```c
// Set garbage collection threshold (in bytes)
js_setgct(js, 32 * 1024);  // Trigger GC when 32KB used
```

### Stack Size Control

Prevent stack overflows by limiting maximum C stack size:

```c
// Set maximum C stack size
js_setmaxcss(js, 1024);  // 1KB stack size limit
```

## Building

### Compiling

```bash
# Build the library
make

# Run tests
make main_test
```

### Including in Your Project

```c
#include "simplejs.h"

// Link with -lsimplejs
```

## API Reference

### Core Functions

- `struct js* js_create(void* buf, size_t len)` - Initialize JS engine in provided memory
- `jsval_t js_eval(struct js*, const char* code, size_t len)` - Execute JS code
- `const char* js_str(struct js*, jsval_t val)` - Convert JS value to string
- `void js_setgct(struct js*, size_t threshold)` - Set garbage collection threshold
- `void js_setmaxcss(struct js*, size_t size)` - Set maximum C stack size
- `void js_stats(struct js*, size_t* total, size_t* lwm, size_t* css)` - Get memory statistics

### Value Creation

- `jsval_t js_mkundef(void)` - Create undefined value
- `jsval_t js_mknull(void)` - Create null value
- `jsval_t js_mktrue(void)` - Create true value
- `jsval_t js_mkfalse(void)` - Create false value
- `jsval_t js_mknum(double val)` - Create number value
- `jsval_t js_mkstr(struct js*, const void* data, size_t len)` - Create string value
- `jsval_t js_mkobj(struct js*)` - Create empty object
- `jsval_t js_mkfun(jsval_t (*fn)(struct js*, jsval_t*, int))` - Create function

### Value Extraction

- `int js_type(jsval_t val)` - Get value type
- `double js_getnum(jsval_t val)` - Extract number
- `int js_getbool(jsval_t val)` - Extract boolean as 0 or 1
- `char* js_getstr(struct js*, jsval_t val, size_t* len)` - Extract string

### Value Types

- `JS_UNDEF` - undefined value
- `JS_NULL` - null value
- `JS_TRUE` - true value
- `JS_FALSE` - false value
- `JS_STR` - string value
- `JS_NUM` - number value
- `JS_ERR` - error value
- `JS_PRIV` - private implementation value

## License

MIT License

## å‚è€ƒ
1. https://github.com/cesanta/elk/